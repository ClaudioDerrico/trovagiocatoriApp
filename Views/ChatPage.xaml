<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="trovagiocatoriApp.Views.ChatPage"
             Title="Chat Privata"
             BackgroundColor="#F8F9FA">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Stili per i messaggi CON MAGGIORE CONTRASTO PER LO SFONDO -->
            <Style x:Key="SentMessageStyle" TargetType="Frame">
                <Setter Property="BackgroundColor" Value="#007AFF"/>
                <Setter Property="CornerRadius" Value="18"/>
                <Setter Property="Padding" Value="12,8"/>
                <Setter Property="Margin" Value="50,4,16,4"/>
                <Setter Property="HorizontalOptions" Value="End"/>
                <Setter Property="HasShadow" Value="True"/>
                <Setter Property="Shadow">
                    <Setter.Value>
                        <Shadow Brush="#40000000" Offset="0,2" Radius="4" Opacity="0.3"/>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="ReceivedMessageStyle" TargetType="Frame">
                <Setter Property="BackgroundColor" Value="#FFFFFF"/>
                <Setter Property="CornerRadius" Value="18"/>
                <Setter Property="Padding" Value="12,8"/>
                <Setter Property="Margin" Value="16,4,50,4"/>
                <Setter Property="HorizontalOptions" Value="Start"/>
                <Setter Property="HasShadow" Value="True"/>
                <Setter Property="Shadow">
                    <Setter.Value>
                        <Shadow Brush="#40000000" Offset="0,2" Radius="4" Opacity="0.3"/>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="SentMessageTextStyle" TargetType="Label">
                <Setter Property="TextColor" Value="White"/>
                <Setter Property="FontSize" Value="16"/>
                <Setter Property="LineBreakMode" Value="WordWrap"/>
            </Style>

            <Style x:Key="ReceivedMessageTextStyle" TargetType="Label">
                <Setter Property="TextColor" Value="#1a1a1a"/>
                <Setter Property="FontSize" Value="16"/>
                <Setter Property="LineBreakMode" Value="WordWrap"/>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*,Auto,Auto">

        <!-- Header con info chat -->
        <Frame Grid.Row="0" BackgroundColor="#007AFF" CornerRadius="0" Padding="20,16" HasShadow="True">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <ImageButton Grid.Column="0" 
                           Source="back_arrow_white.png" 
                           BackgroundColor="Transparent"
                           WidthRequest="24" 
                           HeightRequest="24"
                           VerticalOptions="Center"
                           Clicked="OnBackButtonClicked"/>

                <VerticalStackLayout Grid.Column="1" Spacing="4" Margin="16,0,0,0">
                    <Label x:Name="PostTitleLabel" 
                           Text="Chat Privata"
                           TextColor="White"
                           FontAttributes="Bold"
                           FontSize="16"/>
                    <Label x:Name="ChatWithLabel"
                           Text="Chat con: Utente"
                           TextColor="White"
                           Opacity="0.9"
                           FontSize="14"/>
                </VerticalStackLayout>

                <Frame Grid.Column="2"
                       x:Name="ConnectionStatusFrame"
                       BackgroundColor="#10B981"
                       CornerRadius="8"
                       Padding="8,4"
                       VerticalOptions="Center">
                    <Label x:Name="ConnectionStatusLabel"
                           Text="Online"
                           TextColor="White"
                           FontSize="12"
                           FontAttributes="Bold"/>
                </Frame>
            </Grid>
        </Frame>

        <!-- Area messaggi CON SFONDO -->
        <Grid Grid.Row="1">
            <!-- Immagine di sfondo -->
            <Image Source="sfondo.png"
                   Aspect="AspectFill"
                   Opacity="0.3"/>

            <!-- Overlay semi-trasparente per migliorare la leggibilità -->
            <BoxView BackgroundColor="White"
                     Opacity="0.1"/>

            <!-- ScrollView con i messaggi -->
            <ScrollView x:Name="MessagesScrollView" Padding="0,8">
                <StackLayout x:Name="MessagesContainer" Spacing="0">
                    <!-- I messaggi verranno aggiunti dinamicamente qui -->

                    <!-- Placeholder per quando non ci sono messaggi  -->
                    <Grid x:Name="EmptyStateContainer" 
                          IsVisible="True"
                          RowDefinitions="Auto,Auto,Auto"
                          RowSpacing="16"
                          VerticalOptions="CenterAndExpand" 
                          HorizontalOptions="Center"
                          Padding="40">

                        <Frame Grid.Row="0"
                               BackgroundColor="White"
                               Opacity="0.9"
                               CornerRadius="20"
                               Padding="30"
                               HasShadow="True"
                               HorizontalOptions="Center">

                            <Grid RowDefinitions="Auto,Auto,Auto" 
                                  RowSpacing="16"
                                  HorizontalOptions="Center">

                                <Label Grid.Row="0" 
                                       Text="💬" 
                                       FontSize="48" 
                                       HorizontalOptions="Center"
                                       HorizontalTextAlignment="Center"/>

                                <Label Grid.Row="1" 
                                       Text="Inizia una conversazione" 
                                       FontSize="18" 
                                       FontAttributes="Bold"
                                       TextColor="#333333"
                                       HorizontalOptions="Center"
                                       HorizontalTextAlignment="Center"/>

                                <Label Grid.Row="2" 
                                       Text="I tuoi messaggi appariranno qui"
                                       FontSize="14"
                                       TextColor="#666666"
                                       HorizontalOptions="Center"
                                       HorizontalTextAlignment="Center"/>
                            </Grid>
                        </Frame>
                    </Grid>
                </StackLayout>
            </ScrollView>
        </Grid>

        <!-- Indicatore typing -->
        <Frame Grid.Row="2" 
               x:Name="TypingIndicator"
               BackgroundColor="#E9ECEF"
               CornerRadius="18"
               Padding="16,8"
               Margin="16,4,50,8"
               HorizontalOptions="Start"
               IsVisible="False">
            <StackLayout Orientation="Horizontal" Spacing="8">
                <!-- Animazione typing (3 pallini) -->
                <Label Text="●" TextColor="#666666" FontSize="8" x:Name="Dot1"/>
                <Label Text="●" TextColor="#666666" FontSize="8" x:Name="Dot2"/>
                <Label Text="●" TextColor="#666666" FontSize="8" x:Name="Dot3"/>
                <Label x:Name="TypingLabel"
                       Text="sta scrivendo..."
                       TextColor="#666666"
                       FontSize="14"
                       FontAttributes="Italic"
                       VerticalOptions="Center"/>
            </StackLayout>
        </Frame>

        <!-- Input area -->
        <Frame Grid.Row="3"
               BackgroundColor="White"
               CornerRadius="0"
               Padding="16"
               HasShadow="True">
            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                <Frame Grid.Column="0"
                       BackgroundColor="#F1F3F4"
                       CornerRadius="20"
                       Padding="0"
                       HasShadow="False">
                    <Entry x:Name="MessageEntry"
                           Placeholder="Scrivi un messaggio..."
                           BackgroundColor="Transparent"
                           FontSize="16"
                           Margin="16,0"
                           TextChanged="OnMessageTextChanged"
                           Completed="OnSendMessageClicked"/>
                </Frame>

                <Button Grid.Column="1"
                        x:Name="SendButton"
                        Text="📤"
                        FontSize="20"
                        BackgroundColor="#007AFF"
                        TextColor="White"
                        CornerRadius="25"
                        WidthRequest="50"
                        HeightRequest="50"
                        Clicked="OnSendMessageClicked"
                        IsEnabled="False"/>
            </Grid>
        </Frame>
    </Grid>
</ContentPage>