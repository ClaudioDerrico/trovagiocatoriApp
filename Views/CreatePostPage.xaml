<?xml version="1.0" encoding="utf-8" ?>
<ContentPage 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:converters="clr-namespace:trovagiocatoriApp.Converters"
    x:Class="trovagiocatoriApp.Views.CreatePostPage"
    Title="Nuovo Post"
    BackgroundColor="#f8f9fa">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:IsNotNullConverter x:Key="IsNotNullConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*,Auto" RowSpacing="0">
        <!-- Header -->
        <Grid Grid.Row="0" BackgroundColor="#404040" Padding="20,15">
            <Label Text="🏟️ Crea un nuovo evento sportivo" 
                   TextColor="White" 
                   FontSize="20" 
                   FontAttributes="Bold" 
                   HorizontalOptions="Start"
                   VerticalOptions="Center"/>
        </Grid>

        <!-- Form Content -->
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Padding="16" Spacing="12">
                <!-- Sport Selector -->
                <Label Text="Sport" FontSize="14" TextColor="#555555" Margin="0,0,0,-5"/>
                <Frame Padding="0" CornerRadius="8" HasShadow="False" BorderColor="#e0e0e0">
                    <Picker x:Name="SportPicker" 
                            Title="Seleziona uno sport" 
                            ItemsSource="{Binding SportOptions}"
                            SelectedIndexChanged="OnSportPickerSelectedIndexChanged"
                            Margin="12,0" 
                            HeightRequest="55"/>
                </Frame>

                <!-- Titolo -->
                <Label Text="Titolo evento" FontSize="14" TextColor="#555555" Margin="0,0,0,-5"/>
                <Frame Padding="0" CornerRadius="8" HasShadow="False" BorderColor="#e0e0e0">
                    <Grid ColumnDefinitions="*, Auto">
                        <Entry x:Name="TitoloEntry" 
                               Placeholder="Es: Cerco giocatori per partita amichevole" 
                               MaxLength="50" 
                               TextChanged="OnTitoloTextChanged"
                               Margin="12,0" 
                               HeightRequest="48"
                               VerticalOptions="Center"/>
                        <Label x:Name="CaratteriRimanenti" 
                               Grid.Column="1" 
                               FontSize="12" 
                               TextColor="#757575"
                               Margin="0,0,12,0"
                               VerticalOptions="Center"/>
                    </Grid>
                </Frame>

                <!-- Selezione Campo Sportivo -->
                <Label Text="Campo Sportivo" FontSize="14" TextColor="#555555" Margin="0,10,0,-5"/>
                <Frame Padding="12" CornerRadius="8" HasShadow="False" BorderColor="#e0e0e0" BackgroundColor="#f8f9fa">
                    <VerticalStackLayout Spacing="10">

                        <!-- Campo selezionato (se presente) -->
                        <Frame x:Name="SelectedFieldFrame" 
                               IsVisible="{Binding SelectedSportField, Converter={StaticResource IsNotNullConverter}}"
                               BackgroundColor="#e8f5e8" 
                               BorderColor="#4CAF50" 
                               CornerRadius="8" 
                               Padding="12"
                               HasShadow="False">
                            <VerticalStackLayout Spacing="4">
                                <Label Text="{Binding SelectedSportField.Nome}" 
                                       FontAttributes="Bold" 
                                       FontSize="16" 
                                       TextColor="#2e7d32"/>
                                <Label Text="{Binding SelectedSportField.Indirizzo}" 
                                       FontSize="14" 
                                       TextColor="#555"/>
                                <Label Text="{Binding SelectedSportField.Tipo, StringFormat='🏟️ {0}'}" 
                                       FontSize="12" 
                                       TextColor="#777"/>
                                <Label Text="{Binding SelectedSportField.Descrizione}" 
                                       FontSize="12" 
                                       TextColor="#666"
                                       LineBreakMode="WordWrap"/>
                            </VerticalStackLayout>
                        </Frame>

                        <!-- Filtro per provincia -->
                        <VerticalStackLayout Spacing="5">
                            <Label Text="Filtra per provincia:" FontSize="12" TextColor="#666"/>
                            <Entry x:Name="ProvinciaEntry" 
                                   Placeholder="Digita una provincia..." 
                                   TextChanged="ProvinciaEntry_TextChanged"
                                   BackgroundColor="White"
                                   HeightRequest="40"/>

                            <!-- Suggerimenti province -->
                            <ListView x:Name="ProvinceSuggestionsList"
                                      ItemsSource="{Binding FilteredProvinces}"
                                      IsVisible="False"
                                      SelectionMode="Single"
                                      HeightRequest="120"
                                      BackgroundColor="White"
                                      ItemSelected="ProvinceSuggestionsList_ItemSelected"
                                      Margin="0,2">
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <ViewCell>
                                            <Grid Padding="12,8">
                                                <Label Text="{Binding .}" FontSize="14" TextColor="#333333"/>
                                            </Grid>
                                        </ViewCell>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                        </VerticalStackLayout>

                        <!-- Lista campi disponibili -->
                        <VerticalStackLayout Spacing="5">
                            <Label Text="Campi disponibili per lo sport selezionato:" FontSize="12" TextColor="#666"/>
                            <CollectionView x:Name="SportFieldsCollectionView"
                                            ItemsSource="{Binding FilteredSportFields}"
                                            SelectionMode="Single"
                                            SelectionChanged="OnSportFieldSelected"
                                            HeightRequest="200"
                                            BackgroundColor="White">
                                <CollectionView.ItemsLayout>
                                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="8"/>
                                </CollectionView.ItemsLayout>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Border Stroke="#e0e0e0" 
                                                StrokeThickness="1" 
                                                BackgroundColor="White"
                                                StrokeShape="RoundRectangle 8"
                                                Padding="12">
                                            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto,Auto">
                                                <Label Grid.Row="0" Grid.Column="0"
                                                       Text="{Binding Nome}" 
                                                       FontAttributes="Bold" 
                                                       FontSize="14" 
                                                       TextColor="#333"/>
                                                <Label Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                                       Text="{Binding Indirizzo}" 
                                                       FontSize="12" 
                                                       TextColor="#666"/>
                                                <Label Grid.Row="2" Grid.Column="0"
                                                       Text="{Binding Tipo, StringFormat='🏟️ {0}'}" 
                                                       FontSize="11" 
                                                       TextColor="#888"/>
                                                <Label Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2"
                                                       Text="{Binding SportsText, StringFormat='⚽ Sports: {0}'}" 
                                                       FontSize="10" 
                                                       TextColor="#FC4C02"
                                                       FontAttributes="Bold"/>
                                                <Label Grid.Row="0" Grid.Column="1"
                                                       Text="📍" 
                                                       FontSize="16" 
                                                       VerticalOptions="Center"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                                <CollectionView.EmptyView>
                                    <StackLayout>
                                        <Label Text="🏟️" FontSize="30" HorizontalOptions="Center" TextColor="#ccc" Margin="0,10,0,5"/>
                                        <Label Text="Nessun campo disponibile" 
                                               HorizontalOptions="Center" 
                                               FontSize="14" 
                                               TextColor="#999"/>
                                        <Label Text="Prova a selezionare prima uno sport e una provincia" 
                                               HorizontalOptions="Center" 
                                               FontSize="12" 
                                               TextColor="#bbb"
                                               HorizontalTextAlignment="Center"/>
                                    </StackLayout>
                                </CollectionView.EmptyView>
                            </CollectionView>
                        </VerticalStackLayout>

                    </VerticalStackLayout>
                </Frame>

                <!-- Città (popolata automaticamente dal campo selezionato) -->
                <Label Text="Città" FontSize="14" TextColor="#555555" Margin="0,0,0,-5"/>
                <Frame Padding="0" CornerRadius="8" HasShadow="False" BorderColor="#e0e0e0">
                    <Grid ColumnDefinitions="*, Auto">
                        <Entry x:Name="CittaEntry" 
                               Placeholder="Seleziona prima un campo..." 
                               IsReadOnly="True"
                               BackgroundColor="#f5f5f5"
                               MaxLength="35" 
                               TextChanged="OnCittaTextChanged"
                               Margin="12,0" 
                               HeightRequest="48"
                               VerticalOptions="Center"/>
                        <Label x:Name="CaratteriRimanentiCitta" 
                               Grid.Column="1" 
                               FontSize="10" 
                               TextColor="#757575"
                               Margin="0,0,8,0"
                               VerticalOptions="Center"/>
                    </Grid>
                </Frame>

                <!-- Data e Ora -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                    <VerticalStackLayout Grid.Column="0" Spacing="2">
                        <Label Text="Data" FontSize="14" TextColor="#555555" Margin="0,0,0,-5"/>
                        <Frame Padding="0" CornerRadius="8" HasShadow="False" BorderColor="#e0e0e0">
                            <DatePicker x:Name="DataPartitaPicker" 
                                        MinimumDate="{Binding CurrentDate}" 
                                        MaximumDate="{Binding MaxDate}" 
                                        Margin="12,0" 
                                        HeightRequest="48"/>
                        </Frame>
                    </VerticalStackLayout>

                    <VerticalStackLayout Grid.Column="1" Spacing="2">
                        <Label Text="Ora" FontSize="14" TextColor="#555555" Margin="0,0,0,-5"/>
                        <Frame Padding="0" CornerRadius="8" HasShadow="False" BorderColor="#e0e0e0">
                            <TimePicker x:Name="OraPartitaPicker" 
                                        Margin="12,0" 
                                        HeightRequest="48"/>
                        </Frame>
                    </VerticalStackLayout>
                </Grid>

                <!-- Commento -->
                <Label Text="Descrizione" FontSize="14" TextColor="#555555" Margin="0,0,0,-5"/>
                <Frame Padding="12,8" CornerRadius="8" HasShadow="False" BorderColor="#e0e0e0">
                    <VerticalStackLayout Spacing="5">
                        <Editor x:Name="CommentoEditor"
                                Placeholder="Inserisci ulteriori dettagli sull'evento..."
                                AutoSize="TextChanges"
                                HeightRequest="100"
                                TextChanged="OnCommentoTextChanged"/>
                        <Label x:Name="CharCountLabel" 
                               FontSize="12" 
                               TextColor="#757575" 
                               HorizontalOptions="End"/>
                    </VerticalStackLayout>
                </Frame>
            </VerticalStackLayout>
        </ScrollView>

        <!-- Footer with Button -->
        <Grid Grid.Row="2" BackgroundColor="White" Padding="16">
            <Button Text="⚽ PUBBLICA EVENTO"
                    Clicked="OnCreatePostClicked"
                    BackgroundColor="#FC4C02"
                    TextColor="White"
                    FontAttributes="Bold"
                    CornerRadius="25"
                    HeightRequest="50">
                <Button.Shadow>
                    <Shadow Brush="#80FC4C02" Offset="0,4" Radius="8" Opacity="0.3"/>
                </Button.Shadow>
            </Button>
        </Grid>
    </Grid>
</ContentPage>