<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
 xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
 xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
 xmlns:converters="clr-namespace:trovagiocatoriApp.Converters"
 x:Class="trovagiocatoriApp.Views.PostPage"
 Title="Risultati"
 BackgroundColor="#F9FAFE">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Converters -->
            <converters:IsGreaterThanZeroConverter x:Key="IsGreaterThanZeroConverter"/>
            <converters:AvailabilityColorConverter x:Key="AvailabilityColorConverter"/>
            <converters:AvailabilityTextConverter x:Key="AvailabilityTextConverter"/>

            <!-- Stili moderni -->
            <Style x:Key="PageTitle" TargetType="Label">
                <Setter Property="FontFamily" Value="OpenSansBold"/>
                <Setter Property="FontSize" Value="24"/>
                <Setter Property="TextColor" Value="#1D2637"/>
                <Setter Property="HorizontalOptions" Value="Center"/>
                <Setter Property="Margin" Value="0,0,0,16"/>
            </Style>
            <Style x:Key="CardTitle" TargetType="Label">
                <Setter Property="FontFamily" Value="OpenSansSemiBold"/>
                <Setter Property="FontSize" Value="18"/>
                <Setter Property="TextColor" Value="#1D2637"/>
                <Setter Property="LineHeight" Value="1.4"/>
                <Setter Property="Margin" Value="0,0,0,6"/>
            </Style>
            <Style x:Key="CardLocation" TargetType="Label">
                <Setter Property="FontFamily" Value="OpenSansMedium"/>
                <Setter Property="FontSize" Value="14"/>
                <Setter Property="TextColor" Value="#5B6A82"/>
            </Style>
            <Style x:Key="CardDateTime" TargetType="Label">
                <Setter Property="FontFamily" Value="OpenSansRegular"/>
                <Setter Property="FontSize" Value="13"/>
                <Setter Property="TextColor" Value="#7F8C8D"/>
            </Style>
            <Style x:Key="CardComment" TargetType="Label">
                <Setter Property="FontFamily" Value="OpenSansRegular"/>
                <Setter Property="FontSize" Value="14"/>
                <Setter Property="TextColor" Value="#4A5568"/>
                <Setter Property="LineBreakMode" Value="TailTruncation"/>
                <Setter Property="MaxLines" Value="2"/>
                <Setter Property="LineHeight" Value="1.4"/>
            </Style>
            <Style x:Key="PostCard" TargetType="Frame">
                <Setter Property="CornerRadius" Value="16"/>
                <Setter Property="HasShadow" Value="True"/>
                <Setter Property="Shadow">
                    <Setter.Value>
                        <Shadow Brush="#15000000" Offset="0,4" Radius="12" Opacity="0.1"/>
                    </Setter.Value>
                </Setter>
                <Setter Property="Padding" Value="20"/>
                <Setter Property="Margin" Value="0"/>
                <!-- Nessun margine: gestito da ItemSpacing -->
                <Setter Property="BackgroundColor" Value="White"/>
            </Style>
            <Style x:Key="IconStyle" TargetType="Image">
                <Setter Property="WidthRequest" Value="16"/>
                <Setter Property="HeightRequest" Value="16"/>
                <Setter Property="VerticalOptions" Value="Center"/>
                <Setter Property="Margin" Value="0,0,8,0"/>
            </Style>
            <Style x:Key="HeaderContainer" TargetType="Grid">
                <Setter Property="BackgroundColor" Value="#404040"/>
                <Setter Property="Padding" Value="20,32,20,24"/>
            </Style>

            <Style x:Key="SearchBox" TargetType="Frame">
                <Setter Property="CornerRadius" Value="12"/>
                <Setter Property="HasShadow" Value="False"/>
                <Setter Property="BackgroundColor" Value="White"/>
                <Setter Property="Padding" Value="16,0"/>
                <Setter Property="HeightRequest" Value="50"/>
            </Style>
            <Style x:Key="EmptyStateMessage" TargetType="Label">
                <Setter Property="FontFamily" Value="OpenSansRegular"/>
                <Setter Property="FontSize" Value="16"/>
                <Setter Property="TextColor" Value="#7F8C8D"/>
                <Setter Property="HorizontalOptions" Value="Center"/>
                <Setter Property="VerticalOptions" Value="Center"/>
                <Setter Property="HorizontalTextAlignment" Value="Center"/>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*">
        <!-- Header con titolo principale e navigazione -->
        <Grid Style="{StaticResource HeaderContainer}">
            <Grid ColumnDefinitions="Auto,*,Auto" VerticalOptions="Center">
                <Label Grid.Column="1"
                   x:Name="TitleLabel"
                   FontFamily="OpenSansBold"
                   FontSize="22"
                   TextColor="White"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"/>
                <ImageButton Grid.Column="2"
                         Source="filter.png"
                         BackgroundColor="Transparent"
                         Clicked="OnFilterButtonClicked"
                         VerticalOptions="Center"
                         IsVisible="True"/>
            </Grid>
        </Grid>

        <!-- Contenuto principale con ricerca e lista -->
        <Grid Grid.Row="1" RowDefinitions="Auto,*" Padding="0">
            <!-- Area di ricerca -->
            <Frame Style="{StaticResource SearchBox}" 
               Margin="20,-25,20,16"
               VerticalOptions="Start">
                <Grid ColumnDefinitions="Auto,*">
                    <Image Grid.Column="0"
                       Source="search.png"
                       HeightRequest="18"
                       WidthRequest="18"
                       VerticalOptions="Center"/>
                    <Entry Grid.Column="1"
                       Placeholder="Cerca partite..."
                       PlaceholderColor="#A0AEC0"
                       FontFamily="OpenSansRegular"
                       FontSize="14"
                       TextColor="#1D2637"
                       VerticalOptions="Center"
                       Margin="8,0,0,0"
                       x:Name="SearchEntry"
                       TextChanged="OnSearchTextChanged"/>
                </Grid>
            </Frame>

            <!-- Lista dei post -->
            <RefreshView Grid.Row="1" 
                     x:Name="PostsRefreshView"
                     Refreshing="OnRefreshing"
                     Margin="20,0,20,20">
                <CollectionView x:Name="PostsCollectionView"
                            SelectionMode="Single"
                            SelectionChanged="OnPostSelected"
                            EmptyView="Nessuna partita disponibile al momento">

                    <!-- Spazio tra i post -->
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical" ItemSpacing="16"/>
                    </CollectionView.ItemsLayout>

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame Style="{StaticResource PostCard}">
                                <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto" RowSpacing="10">
                                    <!-- Titolo e Livello -->
                                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                                        <Label Text="{Binding titolo}"
                                               Style="{StaticResource CardTitle}"
                                               Grid.Column="0"/>
                                        <!-- Badge Livello -->
                                        <Frame Grid.Column="1"
                                               BackgroundColor="{Binding LivelloColor}"
                                               CornerRadius="12"
                                               Padding="8,4"
                                               HasShadow="False"
                                               VerticalOptions="Start">
                                            <Label Text="{Binding LivelloDisplayText}"
                                                   TextColor="White"
                                                   FontSize="11"
                                                   FontAttributes="Bold"/>
                                        </Frame>
                                    </Grid>

                                    <!-- LocalitÃ  con icona -->
                                    <Grid Grid.Row="1" ColumnDefinitions="Auto,*">
                                        <Image Source="location_pin.png"
                                               Style="{StaticResource IconStyle}"/>
                                        <Label Text="{Binding citta}"
                                               Grid.Column="1"
                                               Style="{StaticResource CardLocation}"/>
                                    </Grid>

                                    <!-- Data e ora con icone -->
                                    <Grid Grid.Row="2" ColumnDefinitions="Auto,*,Auto,*">
                                        <Image Source="calendar.png"
                                               Grid.Column="0"
                                               Style="{StaticResource IconStyle}"/>
                                        <Label Text="{Binding data_partita}"
                                               Grid.Column="1"
                                               Style="{StaticResource CardDateTime}"/>
                                        <Image Source="clock.png"
                                               Grid.Column="2"
                                               Style="{StaticResource IconStyle}"
                                               Margin="12,0,8,0"/>
                                        <Label Text="{Binding ora_partita}"
                                               Grid.Column="3"
                                               Style="{StaticResource CardDateTime}"/>
                                    </Grid>

                                    <!-- Sport e Campo (se presente) -->
                                    <Grid Grid.Row="3" ColumnDefinitions="Auto,*">
                                        <Image Source="sports_icon.png"
                                               Grid.Column="0"
                                               Style="{StaticResource IconStyle}"/>
                                        <Label Grid.Column="1"
                                               Style="{StaticResource CardDateTime}">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="{Binding sport}"/>
                                                    <Span Text="{Binding campo.nome, StringFormat=' - {0}'}"/>
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                    </Grid>

                                    <!-- AGGIORNATO: Numero Giocatori con stato partecipanti -->
                                    <Grid Grid.Row="4" ColumnDefinitions="Auto,*,Auto">
                                        <Image Source="people_icon.png"
                                               Grid.Column="0"
                                               Style="{StaticResource IconStyle}"/>

                                        <VerticalStackLayout Grid.Column="1" Spacing="2">
                                            <Label Text="{Binding NumeroGiocatoriText}"
                                                   Style="{StaticResource CardDateTime}"
                                                   TextColor="#2196F3"
                                                   FontAttributes="Bold"/>
                                            <!-- NUOVO: Mostra partecipanti iscritti -->
                                            <Label FontSize="11" TextColor="#666">
                                                <Label.FormattedText>
                                                    <FormattedString>
                                                        <Span Text="ðŸ‘¥ "/>
                                                        <Span Text="{Binding partecipanti_iscritti}"/>
                                                        <Span Text=" iscritti â€¢ "/>
                                                        <Span Text="{Binding posti_disponibili}"/>
                                                        <Span Text=" liberi"/>
                                                    </FormattedString>
                                                </Label.FormattedText>
                                            </Label>
                                        </VerticalStackLayout>

                                        <!-- NUOVO: Badge disponibilitÃ  -->
                                        <Frame Grid.Column="2"
                                               CornerRadius="10"
                                               Padding="6,3"
                                               HasShadow="False"
                                               VerticalOptions="Start">
                                            <Frame.Triggers>
                                                <DataTrigger TargetType="Frame" Binding="{Binding posti_disponibili}" Value="0">
                                                    <Setter Property="BackgroundColor" Value="#FF5252"/>
                                                </DataTrigger>
                                            </Frame.Triggers>

                                            <!-- Default: Verde per disponibile -->
                                            <Frame.BackgroundColor>
                                                <Binding Path="posti_disponibili">
                                                    <Binding.Converter>
                                                        <converters:AvailabilityColorConverter/>
                                                    </Binding.Converter>
                                                </Binding>
                                            </Frame.BackgroundColor>

                                            <Label FontSize="10" 
                                                   FontAttributes="Bold" 
                                                   TextColor="White">
                                                <Label.Text>
                                                    <Binding Path="posti_disponibili">
                                                        <Binding.Converter>
                                                            <converters:AvailabilityTextConverter/>
                                                        </Binding.Converter>
                                                    </Binding>
                                                </Label.Text>
                                            </Label>
                                        </Frame>
                                    </Grid>

                                    <!-- Separatore -->
                                    <BoxView Grid.Row="5" 
                                             HeightRequest="1" 
                                             Color="#F0F2F5" 
                                             Margin="0,4,0,8"/>

                                    <!-- NUOVO: Anteprima partecipanti (solo se ci sono iscritti) -->
                                    <Grid Grid.Row="6" 
                                          ColumnDefinitions="Auto,*"
                                          IsVisible="{Binding partecipanti_iscritti, Converter={StaticResource IsGreaterThanZeroConverter}}">
                                        <Image Source="group_icon.png"
                                               Grid.Column="0"
                                               Style="{StaticResource IconStyle}"/>
                                        <Label Grid.Column="1"
                                               FontSize="11"
                                               TextColor="#888">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="Partecipano: "/>
                                                    <Span Text="{Binding partecipanti_iscritti}"/>
                                                    <Span Text=" giocatori"/>
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                    </Grid>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>

                </CollectionView>
            </RefreshView>
        </Grid>

        <!-- Pulsante Floating Action Button per aggiungere nuovo post -->
        <Button Text="+"
            FontSize="24"
            FontAttributes="Bold"
            TextColor="White"
            BackgroundColor="#4361EE"
            WidthRequest="60"
            HeightRequest="60"
            CornerRadius="30"
            HorizontalOptions="End"
            VerticalOptions="End"
            Margin="0,0,24,24"
            Grid.Row="1"
            Clicked="OnAddPostClicked">
            <Button.Shadow>
                <Shadow Brush="#664361EE" 
                    Offset="0,4" 
                    Radius="8" 
                    Opacity="0.4"/>
            </Button.Shadow>
        </Button>
    </Grid>
</ContentPage>