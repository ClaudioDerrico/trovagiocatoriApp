<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:vm="clr-namespace:trovagiocatoriApp.ViewModels"
             xmlns:converters="clr-namespace:trovagiocatoriApp.Converters"
             x:Class="trovagiocatoriApp.Views.ProfilePage"
             Title="Profilo Utente">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:IsNotNullConverter x:Key="IsNotNullConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">

            <!-- CARD PROFILO -->
            <Frame CornerRadius="20" Padding="0" HasShadow="True"
                   BorderColor="#DDDDDD" BackgroundColor="White"
                   HorizontalOptions="FillAndExpand">
                <Grid RowDefinitions="120,Auto" ColumnDefinitions="*">

                    <!-- Immagine di sfondo -->
                    <Image Grid.Row="0" Source="sfondo_no_color.png"
                           Aspect="AspectFill" />

                    <!-- Contenuto sopra l'immagine -->
                    <VerticalStackLayout Grid.Row="0" Grid.RowSpan="2"
                                         Padding="0,60,0,20"
                                         Spacing="12"
                                         HorizontalOptions="CenterAndExpand">

                        <Frame CornerRadius="70" WidthRequest="140" HeightRequest="140"
                               BorderColor="White" Padding="4" HasShadow="True"
                               IsClippedToBounds="True" BackgroundColor="White"
                               VerticalOptions="Center"
                               HorizontalOptions="Center">
                            <Image x:Name="ProfileImage"
                                   Aspect="AspectFill"
                                   Source="default_avatar.png"
                                   HeightRequest="132"
                                   WidthRequest="132"/>
                        </Frame>

                        <Label x:Name="UsernameLabel"
                               TextColor="#2B2B2B"
                               FontSize="26"
                               FontAttributes="Bold"
                               HorizontalOptions="Center"
                               Margin="0,8,0,0"/>
                    </VerticalStackLayout>
                </Grid>
            </Frame>

            <!-- INFO UTENTE -->
            <Frame CornerRadius="15" Padding="20"
                   BackgroundColor="White" HasShadow="True"
                   BorderColor="#DDDDDD"
                   HorizontalOptions="FillAndExpand">
                <VerticalStackLayout Spacing="12">
                    <Grid ColumnDefinitions="Auto, *" ColumnSpacing="10">
                        <Label Grid.Column="0" Text="Nome" FontAttributes="Bold" TextColor="#4A4A4A" VerticalOptions="Center"/>
                        <Label Grid.Column="1" x:Name="NameLabel" FontSize="16" TextColor="#333333" VerticalOptions="Center"/>
                    </Grid>

                    <BoxView HeightRequest="1" BackgroundColor="#EFEFEF" Margin="0,8,0,8"/>
                    <Grid ColumnDefinitions="Auto, *" ColumnSpacing="10">
                        <Label Grid.Column="0" Text="Cognome" FontAttributes="Bold" TextColor="#4A4A4A" VerticalOptions="Center"/>
                        <Label Grid.Column="1" x:Name="SurnameLabel" FontSize="16" TextColor="#333333" VerticalOptions="Center"/>
                    </Grid>

                    <BoxView HeightRequest="1" BackgroundColor="#EFEFEF" Margin="0,8,0,8"/>
                    <Grid ColumnDefinitions="Auto, *" ColumnSpacing="10">
                        <Label Grid.Column="0" Text="Email" FontAttributes="Bold" TextColor="#4A4A4A" VerticalOptions="Center"/>
                        <Label Grid.Column="1" x:Name="EmailLabel" FontSize="16" TextColor="#333333" VerticalOptions="Center" LineBreakMode="TailTruncation"/>
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <!-- NUOVO: SEZIONE I MIEI POST -->
            <Frame CornerRadius="15" Padding="20"
                   BackgroundColor="White" HasShadow="True"
                   BorderColor="#DDDDDD"
                   HorizontalOptions="FillAndExpand">
                <VerticalStackLayout Spacing="15">
                    <Label Text="ðŸ“ I Miei Post" 
                           FontSize="18" 
                           FontAttributes="Bold" 
                           TextColor="#4CAF50" 
                           HorizontalOptions="Start"/>

                    <!-- Lista dei miei post -->
                    <CollectionView x:Name="MyPostsCollectionView"
                                    SelectionMode="Single"
                                    SelectionChanged="OnMyPostSelected"
                                    EmptyView="Non hai ancora creato eventi">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Vertical" ItemSpacing="12"/>
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border Stroke="#E0E0E0" 
                                        StrokeThickness="1" 
                                        StrokeShape="RoundRectangle 10" 
                                        BackgroundColor="#F0F8F0"
                                        Padding="16">
                                    <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto" RowSpacing="8">
                                        <!-- Header con titolo e status -->
                                        <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0" 
                                                   Text="{Binding titolo}"
                                                   FontAttributes="Bold"
                                                   FontSize="16"
                                                   TextColor="#2E7D32"
                                                   LineBreakMode="TailTruncation"/>

                                            <Frame Grid.Column="1" 
                                                   CornerRadius="8" 
                                                   Padding="6,3" 
                                                   HasShadow="False"
                                                   VerticalOptions="Center">
                                                <!-- Colore dinamico basato sulla disponibilitÃ  -->
                                                <Frame.Triggers>
                                                    <DataTrigger TargetType="Frame" Binding="{Binding is_full}" Value="True">
                                                        <Setter Property="BackgroundColor" Value="#FF5722"/>
                                                    </DataTrigger>
                                                    <DataTrigger TargetType="Frame" Binding="{Binding is_full}" Value="False">
                                                        <Setter Property="BackgroundColor" Value="#4CAF50"/>
                                                    </DataTrigger>
                                                </Frame.Triggers>

                                                <Label FontSize="10" 
                                                       FontAttributes="Bold" 
                                                       TextColor="White">
                                                    <Label.Triggers>
                                                        <DataTrigger TargetType="Label" Binding="{Binding is_full}" Value="True">
                                                            <Setter Property="Text" Value="COMPLETO"/>
                                                        </DataTrigger>
                                                        <DataTrigger TargetType="Label" Binding="{Binding is_full}" Value="False">
                                                            <Setter Property="Text" Value="APERTO"/>
                                                        </DataTrigger>
                                                    </Label.Triggers>
                                                </Label>
                                            </Frame>
                                        </Grid>

                                        <!-- Sport e Data/Ora -->
                                        <Grid Grid.Row="1" ColumnDefinitions="Auto,*,Auto">
                                            <HorizontalStackLayout Grid.Column="0" Spacing="6">
                                                <Label Text="âš½" FontSize="14"/>
                                                <Label Text="{Binding sport}" 
                                                       FontSize="14" 
                                                       FontAttributes="Bold"
                                                       TextColor="#FF6B35"/>
                                            </HorizontalStackLayout>

                                            <HorizontalStackLayout Grid.Column="2" Spacing="10">
                                                <Label Text="{Binding data_partita}" 
                                                       FontSize="13" 
                                                       TextColor="#666"/>
                                                <Label Text="{Binding ora_partita}" 
                                                       FontSize="13" 
                                                       FontAttributes="Bold"
                                                       TextColor="#666"/>
                                            </HorizontalStackLayout>
                                        </Grid>

                                        <!-- LocalitÃ  -->
                                        <HorizontalStackLayout Grid.Row="2" Spacing="8">
                                            <Label Text="ðŸ“" FontSize="14"/>
                                            <Label Text="{Binding citta}" 
                                                   FontSize="13" 
                                                   TextColor="#666"/>
                                            <Label Text="|" 
                                                   FontSize="13" 
                                                   TextColor="#DDD"/>
                                            <Label Text="{Binding provincia}" 
                                                   FontSize="13" 
                                                   TextColor="#666"/>
                                        </HorizontalStackLayout>

                                        <!-- Statistiche partecipanti -->
                                        <Frame Grid.Row="3" 
                                               BackgroundColor="#E8F5E8" 
                                               CornerRadius="8" 
                                               Padding="12,8" 
                                               HasShadow="False"
                                               Margin="0,4,0,0">
                                            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                                                <!-- Richiesti -->
                                                <VerticalStackLayout Grid.Column="0" Spacing="2" HorizontalOptions="Center">
                                                    <Label Text="{Binding numero_giocatori}" 
                                                           FontSize="16" 
                                                           FontAttributes="Bold" 
                                                           TextColor="#2E7D32"
                                                           HorizontalOptions="Center"/>
                                                    <Label Text="Richiesti" 
                                                           FontSize="10" 
                                                           TextColor="#666"
                                                           HorizontalOptions="Center"/>
                                                </VerticalStackLayout>

                                                <!-- Iscritti -->
                                                <VerticalStackLayout Grid.Column="1" Spacing="2" HorizontalOptions="Center">
                                                    <Label Text="{Binding partecipanti_iscritti}" 
                                                           FontSize="16" 
                                                           FontAttributes="Bold" 
                                                           TextColor="#FF9800"
                                                           HorizontalOptions="Center"/>
                                                    <Label Text="Iscritti" 
                                                           FontSize="10" 
                                                           TextColor="#666"
                                                           HorizontalOptions="Center"/>
                                                </VerticalStackLayout>

                                                <!-- Liberi -->
                                                <VerticalStackLayout Grid.Column="2" Spacing="2" HorizontalOptions="Center">
                                                    <Label Text="{Binding posti_disponibili}" 
                                                           FontSize="16" 
                                                           FontAttributes="Bold" 
                                                           HorizontalOptions="Center">
                                                        <Label.Triggers>
                                                            <DataTrigger TargetType="Label" Binding="{Binding posti_disponibili}" Value="0">
                                                                <Setter Property="TextColor" Value="#F44336"/>
                                                            </DataTrigger>
                                                        </Label.Triggers>
                                                        <Label.TextColor>
                                                            <Binding Path="posti_disponibili">
                                                                <Binding.Converter>
                                                                    <converters:AvailabilityColorConverter/>
                                                                </Binding.Converter>
                                                            </Binding>
                                                        </Label.TextColor>
                                                    </Label>
                                                    <Label Text="Liberi" 
                                                           FontSize="10" 
                                                           TextColor="#666"
                                                           HorizontalOptions="Center"/>
                                                </VerticalStackLayout>
                                            </Grid>
                                        </Frame>

                                        <!-- Livello e Campo -->
                                        <HorizontalStackLayout Grid.Row="4" Spacing="15" Margin="0,4,0,0">
                                            <!-- Livello -->
                                            <HorizontalStackLayout Spacing="4">
                                                <Label Text="ðŸ†" FontSize="12"/>
                                                <Label Text="{Binding livello}" 
                                                       FontSize="12" 
                                                       TextColor="#888"/>
                                            </HorizontalStackLayout>

                                            <!-- Campo (se presente) -->
                                            <HorizontalStackLayout Spacing="4" IsVisible="{Binding campo, Converter={StaticResource IsNotNullConverter}}">
                                                <Label Text="ðŸŸï¸" FontSize="12"/>
                                                <Label Text="{Binding campo.nome}" 
                                                       FontSize="12" 
                                                       TextColor="#888"
                                                       LineBreakMode="TailTruncation"/>
                                            </HorizontalStackLayout>
                                        </HorizontalStackLayout>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                        <CollectionView.EmptyView>
                            <VerticalStackLayout Spacing="10" HorizontalOptions="Center" Padding="20">
                                <Label Text="ðŸ“" FontSize="40" HorizontalOptions="Center" Opacity="0.5"/>
                                <Label Text="Non hai ancora creato eventi" 
                                       HorizontalOptions="Center" 
                                       FontSize="16" 
                                       TextColor="#888"/>
                                <Label Text="Crea il tuo primo evento per iniziare!" 
                                       HorizontalOptions="Center" 
                                       FontSize="14" 
                                       TextColor="#AAA"
                                       HorizontalTextAlignment="Center"/>
                            </VerticalStackLayout>
                        </CollectionView.EmptyView>
                    </CollectionView>
                </VerticalStackLayout>
            </Frame>

            <!-- SEZIONE CALENDARIO EVENTI -->
            <Frame CornerRadius="15" Padding="20"
                   BackgroundColor="White" HasShadow="True"
                   BorderColor="#DDDDDD"
                   HorizontalOptions="FillAndExpand">
                <VerticalStackLayout Spacing="15">
                    <Label Text="ðŸ“… I Miei Eventi" 
                           FontSize="18" 
                           FontAttributes="Bold" 
                           TextColor="#2196F3" 
                           HorizontalOptions="Start"/>

                    <!-- Calendario con eventi -->
                    <CollectionView x:Name="CalendarEventsCollectionView"
                                    SelectionMode="Single"
                                    SelectionChanged="OnCalendarEventSelected"
                                    EmptyView="Nessun evento in programma">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Vertical" ItemSpacing="12"/>
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border Stroke="#E0E0E0" 
                                        StrokeThickness="1" 
                                        StrokeShape="RoundRectangle 10" 
                                        BackgroundColor="#F8F9FF"
                                        Padding="16">
                                    <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="6">
                                        <!-- Header con data e sport -->
                                        <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto">
                                            <Frame Grid.Column="0" 
                                                   BackgroundColor="#2196F3" 
                                                   CornerRadius="8" 
                                                   Padding="8,4" 
                                                   HasShadow="False"
                                                   VerticalOptions="Center">
                                                <Label Text="{Binding data_partita}" 
                                                       TextColor="White" 
                                                       FontSize="12" 
                                                       FontAttributes="Bold"/>
                                            </Frame>

                                            <Label Grid.Column="1" 
                                                   Text="{Binding sport, StringFormat='Partita di {0}'}"
                                                   FontAttributes="Bold"
                                                   FontSize="16"
                                                   TextColor="#2196F3"
                                                   VerticalOptions="Center"
                                                   Margin="12,0,0,0"/>

                                            <Label Grid.Column="2" 
                                                   Text="{Binding ora_partita}"
                                                   FontSize="14"
                                                   FontAttributes="Bold"
                                                   TextColor="#666"
                                                   VerticalOptions="Center"/>
                                        </Grid>

                                        <!-- Titolo evento -->
                                        <Label Grid.Row="1" 
                                               Text="{Binding titolo}"
                                               FontSize="15"
                                               FontAttributes="Bold"
                                               TextColor="#333"
                                               LineBreakMode="TailTruncation"
                                               Margin="0,4,0,0"/>

                                        <!-- LocalitÃ  -->
                                        <HorizontalStackLayout Grid.Row="2" Spacing="8" Margin="0,2,0,0">
                                            <Label Text="ðŸ“" FontSize="14"/>
                                            <Label Text="{Binding citta}" 
                                                   FontSize="13" 
                                                   TextColor="#666"/>
                                            <Label Text="|" 
                                                   FontSize="13" 
                                                   TextColor="#DDD"/>
                                            <Label Text="{Binding provincia}" 
                                                   FontSize="13" 
                                                   TextColor="#666"/>
                                        </HorizontalStackLayout>

                                        <!-- Dettagli aggiuntivi -->
                                        <HorizontalStackLayout Grid.Row="3" Spacing="15" Margin="0,4,0,0">
                                            <!-- Livello -->
                                            <HorizontalStackLayout Spacing="4">
                                                <Label Text="ðŸ†" FontSize="12"/>
                                                <Label Text="{Binding livello}" 
                                                       FontSize="12" 
                                                       TextColor="#888"/>
                                            </HorizontalStackLayout>

                                            <!-- Campo (se presente) -->
                                            <HorizontalStackLayout Spacing="4" IsVisible="{Binding campo, Converter={StaticResource IsNotNullConverter}}">
                                                <Label Text="ðŸŸï¸" FontSize="12"/>
                                                <Label Text="{Binding campo.nome}" 
                                                       FontSize="12" 
                                                       TextColor="#888"
                                                       LineBreakMode="TailTruncation"/>
                                            </HorizontalStackLayout>
                                        </HorizontalStackLayout>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                        <CollectionView.EmptyView>
                            <VerticalStackLayout Spacing="10" HorizontalOptions="Center" Padding="20">
                                <Label Text="ðŸ“…" FontSize="40" HorizontalOptions="Center" Opacity="0.5"/>
                                <Label Text="Nessun evento in programma" 
                                       HorizontalOptions="Center" 
                                       FontSize="16" 
                                       TextColor="#888"/>
                                <Label Text="Iscriviti agli eventi per vederli qui!" 
                                       HorizontalOptions="Center" 
                                       FontSize="14" 
                                       TextColor="#AAA"
                                       HorizontalTextAlignment="Center"/>
                            </VerticalStackLayout>
                        </CollectionView.EmptyView>
                    </CollectionView>
                </VerticalStackLayout>
            </Frame>

            <!-- SEZIONE PREFERITI -->
            <Frame CornerRadius="15" Padding="20"
                   BackgroundColor="White" HasShadow="True"
                   BorderColor="#DDDDDD"
                   HorizontalOptions="FillAndExpand">
                <VerticalStackLayout Spacing="15">
                    <Label Text="â¤ï¸ I Miei Preferiti" 
                           FontSize="18" 
                           FontAttributes="Bold" 
                           TextColor="#FF5A5F" 
                           HorizontalOptions="Start"/>

                    <CollectionView x:Name="FavoritesCollectionView"
                                    SelectionMode="Single"
                                    SelectionChanged="OnFavoriteSelected"
                                    EmptyView="Nessun evento nei preferiti">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Vertical" ItemSpacing="10"/>
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border Stroke="#E0E0E0" 
                                        StrokeThickness="1" 
                                        StrokeShape="RoundRectangle 8" 
                                        BackgroundColor="#FAFAFA"
                                        Padding="15">
                                    <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="5">
                                        <!-- Titolo -->
                                        <Label Grid.Row="0" 
                                               Text="{Binding titolo}"
                                               FontAttributes="Bold"
                                               FontSize="16"
                                               TextColor="#333"
                                               LineBreakMode="TailTruncation"/>

                                        <!-- LocalitÃ  e Sport -->
                                        <HorizontalStackLayout Grid.Row="1" Spacing="15">
                                            <Label Text="{Binding citta, StringFormat='ðŸ“ {0}'}" 
                                                   FontSize="14" 
                                                   TextColor="#666"/>
                                            <Label Text="{Binding sport, StringFormat='âš½ {0}'}" 
                                                   FontSize="14" 
                                                   TextColor="#FC4C02"
                                                   FontAttributes="Bold"/>
                                        </HorizontalStackLayout>

                                        <!-- Data e Ora -->
                                        <HorizontalStackLayout Grid.Row="2" Spacing="15">
                                            <Label Text="{Binding DataPartitaLong, StringFormat='ðŸ“… {0}'}" 
                                                   FontSize="13" 
                                                   TextColor="#888"/>
                                            <Label Text="{Binding OraPartitaFormatted, StringFormat='ðŸ• {0}'}" 
                                                   FontSize="13" 
                                                   TextColor="#888"/>
                                        </HorizontalStackLayout>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Frame>

            <!-- BOTTONI -->
            <VerticalStackLayout Spacing="15" HorizontalOptions="FillAndExpand" Margin="0,10,0,0">
                <Button Text="Modifica Password"
                        FontAttributes="Bold"
                        CornerRadius="12" HeightRequest="52"
                        Background="#5B9CFD"
                        TextColor="White"
                        Clicked="OnNavigateToChangePassword"
                        Margin="5,0"/>

                <Button Text="Logout"
                        FontAttributes="Bold"
                        CornerRadius="12"
                        HeightRequest="52"
                        Background="#FF5A5F"
                        TextColor="White"
                        Clicked="OnLogoutButtonClicked"
                        Margin="5,0"/>
            </VerticalStackLayout>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>